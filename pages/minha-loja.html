<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - Vestio</title>
    <link rel="stylesheet" href="../css/globais.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <nav class="menu-lateral">
        <h3 class="titulo-menu">Principal</h3>
        <a href="dashboard.html" class="menu-link"><span class="menu-icone">üè†</span> In√≠cio</a>
        <a href="pdv.html" class="menu-link"><span class="menu-icone">üõí</span> PDV (Caixa)</a>
        
        <h3 class="titulo-menu">Gest√£o</h3>
        <a href="estoque.html" class="menu-link"><span class="menu-icone">üì¶</span> Estoque</a>
        <a href="clientes.html" class="menu-link"><span class="menu-icone">üë•</span> Clientes</a>
        <a href="relatorios.html" class="menu-link"><span class="menu-icone">üìä</span> Relat√≥rios</a>
        
        <h3 class="titulo-menu">Integra√ß√µes</h3>
        <a href="online.html" class="menu-link"><span class="menu-icone">üåê</span> Pedidos Online</a>
        
        <h3 class="titulo-menu">Configura√ß√µes</h3>
        <a href="usuarios.html" class="menu-link"><span class="menu-icone">üîê</span> Usu√°rios</a>
        <a href="minha-loja.html" class="menu-link ativo"><span class="menu-icone">‚öôÔ∏è</span> Minha Loja</a>
    </nav>

    <header>
        <h1>Configura√ß√µes Master</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="nome-utilizador">Admin</span>
            <button id="btn-logout" style="background: linear-gradient(135deg, #FF453A, #c41e15) !important; width: auto; padding: 0 20px;">SAIR</button>
        </div>
    </header>

    <main>
        <div class="card-config" style="max-width: 600px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <label style="margin-bottom: 10px;">Logotipo da Loja</label>
                <div style="width: 100px; height: 100px; border-radius: 12px; background: rgba(0,0,0,0.3); margin: 0 auto; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px dashed #666;">
                    <img id="preview-logo" src="" style="max-width: 100%; max-height: 100%; display: none;">
                    <span id="placeholder-logo" style="color: #666;">Sem Logo</span>
                </div>
                <label for="input-logo" style="cursor: pointer; color: #64D2FF; font-size: 12px; margin-top: 10px; display: block; text-decoration: underline;">Carregar Imagem</label>
                <input type="file" id="input-logo" accept="image/*" style="display: none;">
            </div>

            <div class="grade-box" style="padding: 15px; border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 10px; background: rgba(10, 132, 255, 0.05) !important;">
                <label style="color: #64D2FF;">Juros no Credi√°rio (%)</label>
                <input type="number" id="juros-crediario" placeholder="Ex: 10" step="0.1">
                
                <label style="color: #64D2FF; margin-top: 10px;">Senha de Gerente (Local)</label>
                <input type="text" id="senha-gerente" placeholder="Para autorizar descontos">
            </div>

            <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

            <h3>Dados da Loja</h3>
            <div class="input-group"><label>Nome Fantasia</label><input type="text" id="loja-nome"></div>
            <div class="input-group" style="margin-top:15px"><label>CNPJ</label><input type="text" id="loja-cnpj"></div>
            <div class="input-group" style="margin-top:15px"><label>Telefone</label><input type="text" id="loja-tel"></div>
            <div class="input-group" style="margin-top:15px"><label>Endere√ßo</label><input type="text" id="loja-end"></div>

            <hr style="border-color: rgba(255,255,255,0.1); margin: 30px 0;">
            
            <h3 style="color: #64D2FF;">Integra√ß√£o Loja Online (E-commerce)</h3>
            <p style="font-size: 13px; color: #94a3b8; margin-bottom: 15px;">
                Ligue o seu sistema ao WooCommerce ou Shopify para sincroniza√ß√£o de estoque e pedidos.
            </p>

            <div class="input-group">
                <label>Plataforma</label>
                <select id="ecom-plataforma" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.05); color: white; border: 1px solid #334155;">
                    <option value="nenhuma">Nenhuma</option>
                    <option value="woocommerce">WooCommerce</option>
                    <option value="shopify">Shopify</option>
                </select>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>URL da Loja (ex: https://sualoja.com.br)</label>
                <input type="text" id="ecom-url" placeholder="https://...">
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>Chave do Consumidor (API Key)</label>
                <input type="text" id="ecom-key" placeholder="ck_xxxxxxxxxxxxxxxxxxxx">
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <label>Segredo do Consumidor (API Secret)</label>
                <input type="password" id="ecom-secret" placeholder="cs_xxxxxxxxxxxxxxxxxxxx">
            </div>
            <button id="btn-salvar-config" class="btn-salvar" style="width: 100%; margin-top: 25px;">üíæ SALVAR ALTERA√á√ïES</button>
        </div>
    </main>

    <script type="module">
        import { db, auth } from '../js/firebase-config.js';
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { validarSenhaMaster } from '../js/saas-utils.js';

        let logoBase64 = "";

        document.addEventListener('DOMContentLoaded', async () => {
            const empresaId = localStorage.getItem('VESTIO_EMPRESA_ID');
            if(!empresaId) return;

            const docRef = doc(db, "empresas", empresaId, "configuracoes", "dados_loja");
            const snap = await getDoc(docRef);
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('loja-nome').value = d.nome || '';
                document.getElementById('loja-cnpj').value = d.cnpj || '';
                document.getElementById('loja-tel').value = d.telefone || '';
                document.getElementById('loja-end').value = d.endereco || '';
                document.getElementById('juros-crediario').value = d.jurosCrediario || 0;
                document.getElementById('senha-gerente').value = d.senhaGerente || 'admin';
                
                // Carregar campos de E-commerce
                if(document.getElementById('ecom-plataforma')) {
                    document.getElementById('ecom-plataforma').value = d.ecom_plataforma || 'nenhuma';
                    document.getElementById('ecom-url').value = d.ecom_url || '';
                    document.getElementById('ecom-key').value = d.ecom_key || '';
                    document.getElementById('ecom-secret').value = d.ecom_secret || '';
                }

                if(d.logo) {
                    logoBase64 = d.logo;
                    document.getElementById('preview-logo').src = d.logo;
                    document.getElementById('preview-logo').style.display = 'block';
                    document.getElementById('placeholder-logo').style.display = 'none';
                }
            }

            document.getElementById('input-logo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onloadend = function(){
                        logoBase64 = reader.result;
                        document.getElementById('preview-logo').src = logoBase64;
                        document.getElementById('preview-logo').style.display = 'block';
                        document.getElementById('placeholder-logo').style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('btn-salvar-config').onclick = async () => {
                const pass = await Swal.fire({ 
                    title: 'Senha Necess√°ria', 
                    input: 'password', 
                    background: '#1e293b', 
                    color: '#fff',
                    confirmButtonText: 'Confirmar'
                });
                
                if (pass.isConfirmed && await validarSenhaMaster(pass.value)) {
                    await setDoc(docRef, {
                        nome: document.getElementById('loja-nome').value,
                        cnpj: document.getElementById('loja-cnpj').value,
                        telefone: document.getElementById('loja-tel').value,
                        endereco: document.getElementById('loja-end').value,
                        jurosCrediario: parseFloat(document.getElementById('juros-crediario').value),
                        senhaGerente: document.getElementById('senha-gerente').value,
                        
                        // Salvando campos de E-commerce
                        ecom_plataforma: document.getElementById('ecom-plataforma').value,
                        ecom_url: document.getElementById('ecom-url').value,
                        ecom_key: document.getElementById('ecom-key').value,
                        ecom_secret: document.getElementById('ecom-secret').value,

                        logo: logoBase64
                    }, { merge: true });
                    
                    localStorage.setItem('VESTIO_LOGO', logoBase64); // Salva para o PDF usar
                    Swal.fire('Sucesso', 'Configura√ß√µes salvas!', 'success');
                } else if (pass.isConfirmed) {
                    Swal.fire('Erro', 'Senha incorreta', 'error');
                }
            };
            
            document.getElementById('btn-logout').onclick = async () => { await signOut(auth); window.location.href="../index.html"; };
        });
    </script>
</body>
</html>