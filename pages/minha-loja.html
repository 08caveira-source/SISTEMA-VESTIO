<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Minha Loja - Vestio</title>
    <link rel="stylesheet" href="../css/globais.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <nav class="menu-lateral">
        <h3 class="titulo-menu">Principal</h3>
        <a href="dashboard.html" class="menu-link"><span class="menu-icone">ğŸ </span> InÃ­cio</a>
        <a href="pdv.html" class="menu-link"><span class="menu-icone">ğŸ›’</span> PDV (Caixa)</a>
        
        <h3 class="titulo-menu">GestÃ£o</h3>
        <a href="estoque.html" class="menu-link"><span class="menu-icone">ğŸ“¦</span> Estoque</a>
        <a href="clientes.html" class="menu-link"><span class="menu-icone">ğŸ‘¥</span> Clientes</a>
        <a href="relatorios.html" class="menu-link"><span class="menu-icone">ğŸ“Š</span> RelatÃ³rios</a>
        
        <h3 class="titulo-menu">IntegraÃ§Ãµes</h3>
        <a href="online.html" class="menu-link"><span class="menu-icone">ğŸŒ</span> Pedidos Online</a>
        
        <h3 class="titulo-menu">ConfiguraÃ§Ãµes</h3>
        <a href="usuarios.html" class="menu-link"><span class="menu-icone">ğŸ”</span> UsuÃ¡rios</a>
        <a href="minha-loja.html" class="menu-link ativo"><span class="menu-icone">âš™ï¸</span> Minha Loja</a>
    </nav>

    <header>
        <h1>ConfiguraÃ§Ãµes Master</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="nome-utilizador">Admin</span>
            <button id="btn-logout" style="background: linear-gradient(135deg, #FF453A, #c41e15) !important; width: auto; padding: 0 20px;">SAIR</button>
        </div>
    </header>

    <main>
        <div class="card-config" style="max-width: 600px; margin: 0 auto;">
            <div style="text-align: center; margin-bottom: 20px;">
                <label style="margin-bottom: 10px;">Logotipo da Loja</label>
                <div style="width: 100px; height: 100px; border-radius: 12px; background: rgba(0,0,0,0.3); margin: 0 auto; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px dashed #666;">
                    <img id="preview-logo" src="" style="max-width: 100%; max-height: 100%; display: none;">
                    <span id="placeholder-logo" style="color: #666;">Sem Logo</span>
                </div>
                <label for="input-logo" style="cursor: pointer; color: #64D2FF; font-size: 12px; margin-top: 10px; display: block; text-decoration: underline;">Carregar Imagem</label>
                <input type="file" id="input-logo" accept="image/*" style="display: none;">
            </div>

            <div class="grade-box" style="padding: 15px; border: 1px solid rgba(10, 132, 255, 0.3); border-radius: 10px; background: rgba(10, 132, 255, 0.05) !important;">
                <label style="color: #64D2FF;">Juros no CrediÃ¡rio (%)</label>
                <input type="number" id="juros-crediario" placeholder="Ex: 10" step="0.1">
                
                <label style="color: #64D2FF; margin-top: 10px;">Senha de Gerente (Local)</label>
                <input type="text" id="senha-gerente" placeholder="Para autorizar descontos">
            </div>

            <hr style="border-color: rgba(255,255,255,0.1); margin: 20px 0;">

            <h3>Dados da Loja</h3>
            <div class="input-group"><label>Nome Fantasia</label><input type="text" id="loja-nome"></div>
            <div class="input-group" style="margin-top:15px"><label>CNPJ</label><input type="text" id="loja-cnpj"></div>
            <div class="input-group" style="margin-top:15px"><label>Telefone</label><input type="text" id="loja-tel"></div>
            <div class="input-group" style="margin-top:15px"><label>EndereÃ§o</label><input type="text" id="loja-end"></div>

            <button id="btn-salvar-config" class="btn-salvar" style="width: 100%; margin-top: 25px;">ğŸ’¾ SALVAR ALTERAÃ‡Ã•ES</button>
        </div>
    </main>

    <script type="module">
        import { db, auth } from '../js/firebase-config.js';
        import { doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { validarSenhaMaster } from '../js/saas-utils.js';

        let logoBase64 = "";

        document.addEventListener('DOMContentLoaded', async () => {
            const empresaId = localStorage.getItem('VESTIO_EMPRESA_ID');
            if(!empresaId) return;

            const docRef = doc(db, "empresas", empresaId, "configuracoes", "dados_loja");
            const snap = await getDoc(docRef);
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('loja-nome').value = d.nome || '';
                document.getElementById('loja-cnpj').value = d.cnpj || '';
                document.getElementById('loja-tel').value = d.telefone || '';
                document.getElementById('loja-end').value = d.endereco || '';
                document.getElementById('juros-crediario').value = d.jurosCrediario || 0;
                document.getElementById('senha-gerente').value = d.senhaGerente || 'admin';
                if(d.logo) {
                    logoBase64 = d.logo;
                    document.getElementById('preview-logo').src = d.logo;
                    document.getElementById('preview-logo').style.display = 'block';
                    document.getElementById('placeholder-logo').style.display = 'none';
                }
            }

            document.getElementById('input-logo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onloadend = function(){
                        logoBase64 = reader.result;
                        document.getElementById('preview-logo').src = logoBase64;
                        document.getElementById('preview-logo').style.display = 'block';
                        document.getElementById('placeholder-logo').style.display = 'none';
                    }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('btn-salvar-config').onclick = async () => {
                const pass = await Swal.fire({ 
                    title: 'Senha NecessÃ¡ria', 
                    input: 'password', 
                    background: '#1e293b', 
                    color: '#fff',
                    confirmButtonText: 'Confirmar'
                });
                
                if (pass.isConfirmed && await validarSenhaMaster(pass.value)) {
                    await setDoc(docRef, {
                        nome: document.getElementById('loja-nome').value,
                        cnpj: document.getElementById('loja-cnpj').value,
                        telefone: document.getElementById('loja-tel').value,
                        endereco: document.getElementById('loja-end').value,
                        jurosCrediario: parseFloat(document.getElementById('juros-crediario').value),
                        senhaGerente: document.getElementById('senha-gerente').value,
                        logo: logoBase64
                    }, { merge: true });
                    
                    localStorage.setItem('VESTIO_LOGO', logoBase64); // Salva para o PDF usar
                    Swal.fire('Sucesso', 'ConfiguraÃ§Ãµes salvas!', 'success');
                } else if (pass.isConfirmed) {
                    Swal.fire('Erro', 'Senha incorreta', 'error');
                }
            };
            
            document.getElementById('btn-logout').onclick = async () => { await signOut(auth); window.location.href="../index.html"; };
        });
    </script>
</body>
</html>