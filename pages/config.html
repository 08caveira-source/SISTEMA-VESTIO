<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes - Vestio</title>
    <link rel="stylesheet" href="../css/globais.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        .config-main-container { display: flex !important; align-items: stretch !important; background: #1e293b !important; border-radius: 8px !important; border: 1px solid #334155 !important; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5) !important; overflow: hidden !important; margin-top: 20px !important; min-height: 600px; }
        .tabs-nav { display: flex !important; flex-direction: column !important; width: 240px !important; background: #0f172a !important; border-right: 1px solid #334155 !important; padding-top: 15px !important; flex-shrink: 0 !important; }
        .tab-btn { background: transparent !important; color: #94a3b8 !important; border: none !important; border-left: 4px solid transparent !important; padding: 16px 20px !important; text-align: left !important; cursor: pointer !important; font-size: 14px !important; transition: 0.2s !important; border-radius: 0 !important; margin: 0 !important; font-family: inherit !important; display: flex !important; align-items: center !important; }
        .tab-btn:hover { background: rgba(255, 255, 255, 0.05) !important; color: white !important; }
        .tab-btn.ativo { background: #1e293b !important; color: #64D2FF !important; font-weight: bold !important; border-left: 4px solid #64D2FF !important; }
        .config-wrapper { flex: 1 !important; padding: 30px 40px !important; background: #1e293b !important; position: relative; }
        .tab-content { display: none !important; animation: fadeIn 0.3s; }
        .tab-content.ativo { display: block !important; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .tabela-usuarios { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .tabela-usuarios th, .tabela-usuarios td { padding: 10px; text-align: left; border-bottom: 1px solid #334155; color: white; }
        .tabela-usuarios th { color: #94a3b8; font-size: 12px; }
        
        .grid-cep { display: grid; grid-template-columns: 1fr 2.5fr; gap: 15px; margin-top: 15px; }
        .grid-end { display: grid; grid-template-columns: 1fr 1.5fr 1.5fr 80px; gap: 15px; margin-top: 15px; }
        
        @media (max-width: 768px) { 
            .config-main-container { flex-direction: column !important; } 
            .tabs-nav { width: 100% !important; border-right: none !important; border-bottom: 1px solid #334155 !important; flex-direction: row !important; overflow-x: auto !important; padding-top: 0 !important; } 
            .tab-btn { border-left: none !important; border-bottom: 4px solid transparent !important; white-space: nowrap !important; } 
            .tab-btn.ativo { border-left: none !important; border-bottom: 4px solid #64D2FF !important; } 
            .config-wrapper { padding: 20px !important; } 
            .grid-cep, .grid-end { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <nav class="menu-lateral">
        <h3 class="titulo-menu">Principal</h3>
        <a href="dashboard.html" class="menu-link"><span class="menu-icone">üè†</span> In√≠cio</a>
        <a href="#" onclick="window.open('pdv.html', 'CaixaPDV', 'width=' + screen.width + ',height=' + screen.height + ',fullscreen=yes,menubar=no,toolbar=no,location=no'); return false;" class="menu-link" style="background: rgba(48, 209, 88, 0.1); color: #30D158; border: 1px dashed #30D158;"><span class="menu-icone">üõí</span> Abrir Caixa (PDV)</a>
        
        <h3 class="titulo-menu">Gest√£o</h3>
        <a href="estoque.html" class="menu-link"><span class="menu-icone">üì¶</span> Estoque</a>
        <a href="clientes.html" class="menu-link"><span class="menu-icone">üë•</span> Clientes</a>
        <a href="relatorios.html" class="menu-link"><span class="menu-icone">üìä</span> Relat√≥rios</a>
        
        <h3 class="titulo-menu">Integra√ß√µes</h3>
        <a href="online.html" class="menu-link"><span class="menu-icone">üåê</span> Pedidos Online</a>
        
        <h3 class="titulo-menu">Configura√ß√µes</h3>
        <a href="config.html" class="menu-link ativo"><span class="menu-icone">‚öôÔ∏è</span> Configura√ß√µes Gerais</a>
    </nav>

    <header>
        <h1>Painel de Configura√ß√µes</h1>
        <div style="display: flex; align-items: center; gap: 15px;">
            <span id="nome-utilizador">Admin</span>
            <button id="btn-logout" class="btn-vermelho" style="width: auto; padding: 0 20px;">SAIR</button>
        </div>
    </header>

    <main>
        <div style="max-width: 900px; margin: 0 auto;">
            <div class="config-main-container">
                <div class="tabs-nav">
                    <button class="tab-btn ativo" onclick="abrirAba('aba-dados', this)">üè¢ Dados da Loja</button>
                    <button class="tab-btn" onclick="abrirAba('aba-logo', this)">üñºÔ∏è Logomarca</button>
                    <button class="tab-btn" onclick="abrirAba('aba-juros', this)">üìà Juros Credi√°rio</button>
                    <button class="tab-btn" onclick="abrirAba('aba-usuarios', this)">üë• Usu√°rios</button>
                    <button class="tab-btn" onclick="abrirAba('aba-ecom', this)">üåê E-commerce</button>
                </div>

                <div class="config-wrapper">
                    
                    <div id="aba-dados" class="tab-content ativo">
                        <h3 style="margin-top: 0; color: #64D2FF; border-bottom: 1px solid #334155; padding-bottom: 10px;">Informa√ß√µes Empresariais</h3>
                        <div class="input-group"><label>Nome Fantasia</label><input type="text" id="loja-nome"></div>
                        <div class="input-group" style="margin-top:15px"><label>CNPJ / NIF</label><input type="text" id="loja-cnpj"></div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div class="input-group"><label>Telefone / WhatsApp</label><input type="text" id="loja-tel"></div>
                        </div>

                        <div class="input-group" style="margin-top:15px; background: rgba(10, 132, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px dashed #0A84FF;">
                            <label style="color: #64D2FF;">üì∑ Instagram da Loja (Para imprimir nas Etiquetas)</label>
                            <input type="text" id="loja-insta" placeholder="Ex: @sua.loja">
                        </div>

                        <h4 style="margin-top: 25px; margin-bottom: 0; color: #94a3b8;">Endere√ßo de Origem (Remetente)</h4>
                        <div class="grid-cep">
                            <div class="input-group">
                                <label>CEP (Digite para buscar)</label>
                                <input type="text" id="loja-cep" placeholder="00000-000" onblur="window.buscarCep('loja')" maxlength="9">
                            </div>
                            <div class="input-group"><label>Rua / Logradouro</label><input type="text" id="loja-rua"></div>
                        </div>
                        <div class="grid-end">
                            <div class="input-group"><label>N√∫mero</label><input type="text" id="loja-num"></div>
                            <div class="input-group"><label>Bairro</label><input type="text" id="loja-bairro"></div>
                            <div class="input-group"><label>Cidade</label><input type="text" id="loja-cidade"></div>
                            <div class="input-group"><label>UF</label><input type="text" id="loja-uf" maxlength="2"></div>
                        </div>

                        <button class="btn-salvar" onclick="salvarConfiguracoesGerais()" style="width: 100%; margin-top: 25px;">üíæ Salvar Dados</button>
                    </div>

                    <div id="aba-logo" class="tab-content">
                        <h3 style="margin-top: 0; color: #64D2FF; border-bottom: 1px solid #334155; padding-bottom: 10px;">Identidade Visual</h3>
                        <p style="color: #94a3b8; font-size: 13px; margin-bottom: 20px;">Utilizada nas etiquetas de roupas, recibos e PDV.</p>
                        <div style="text-align: center; margin-top: 20px;">
                            <div style="width: 150px; height: 150px; border-radius: 12px; background: rgba(0,0,0,0.3); margin: 0 auto; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px dashed #666;">
                                <img id="preview-logo" src="" style="max-width: 100%; max-height: 100%; display: none;">
                                <span id="placeholder-logo" style="color: #666;">Sem Logo</span>
                            </div>
                            <label for="input-logo" style="cursor: pointer; color: #64D2FF; margin-top: 15px; display: inline-block; padding: 10px 20px; border: 1px solid #64D2FF; border-radius: 6px;">üì∏ Escolher Nova Imagem</label>
                            <input type="file" id="input-logo" accept="image/*" style="display: none;">
                        </div>
                        <button class="btn-salvar" onclick="salvarConfiguracoesGerais()" style="width: 100%; margin-top: 30px;">üíæ Salvar Logomarca</button>
                    </div>

                    <div id="aba-juros" class="tab-content">
                        <h3 style="margin-top: 0; color: #64D2FF; border-bottom: 1px solid #334155; padding-bottom: 10px;">Configura√ß√£o Financeira</h3>
                        <div class="input-group"><label style="color: #64D2FF;">Taxa de Juros (%)</label><input type="number" id="juros-crediario" placeholder="Ex: 10" step="0.1" style="font-size: 20px; text-align: center; max-width: 200px;"></div>
                        <button class="btn-salvar" onclick="salvarConfiguracoesGerais()" style="width: 100%; margin-top: 25px;">üíæ Salvar Juros</button>
                    </div>

                    <div id="aba-usuarios" class="tab-content">
                        <h3 style="margin-top: 0; color: #64D2FF; border-bottom: 1px solid #334155; padding-bottom: 10px;">Gerenciamento de Equipe</h3>
                        <form id="form-usuario" style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="input-group"><label>Nome Completo</label><input type="text" id="usr-nome" required></div>
                                <div class="input-group"><label>Cargo</label><select id="usr-cargo" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(0,0,0,0.3); color: white; border: 1px solid #334155;"><option value="Vendedor">Vendedor</option><option value="Gerente">Gerente (Acesso Total)</option></select></div>
                                <div class="input-group" style="grid-column: span 2;"><label>Senha Num√©rica ou Texto</label><input type="text" id="usr-senha" required></div>
                            </div>
                            <button type="submit" class="btn-salvar" style="width: 100%; margin-top: 15px;">‚ûï Adicionar Usu√°rio</button>
                        </form>
                        <table class="tabela-usuarios" style="margin-top: 30px;">
                            <thead><tr><th>Nome</th><th>Cargo</th><th>Senha</th><th>A√ß√µes</th></tr></thead>
                            <tbody id="lista-usuarios"><tr><td colspan="4" style="text-align:center;">Carregando...</td></tr></tbody>
                        </table>
                    </div>

                    <div id="aba-ecom" class="tab-content">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 1px solid #334155; padding-bottom: 10px; margin-bottom: 20px;">
                            <div>
                                <h3 style="color: #64D2FF; margin-top: 0; margin-bottom: 5px;">Sincroniza√ß√£o Online</h3>
                                <p style="font-size: 13px; color: #94a3b8; margin: 0;">Integre o estoque e receba pedidos externos.</p>
                            </div>
                            <button id="btn-instrucoes-ecom" style="background: rgba(10, 132, 255, 0.2); color: #64D2FF; border: 1px solid #0A84FF; padding: 8px 12px; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;">üìñ Manual Detalhado</button>
                        </div>
                        <div style="background: rgba(48, 209, 88, 0.1); border: 1px dashed #30D158; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <span style="color: #30D158; font-weight: bold; display: block; margin-bottom: 5px;">Seu Identificador (Webhook ID)</span>
                                <span style="color: #94a3b8; font-size: 12px;">Use este c√≥digo no final do link do servidor para receber pedidos.</span>
                            </div>
                            <button onclick="copiarIdentificador()" style="background: #30D158; color: black; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; font-weight: bold;">üìã Copiar ID</button>
                        </div>
                        <div class="input-group"><label>Plataforma (Selecione a sua Loja)</label>
                            <select id="ecom-plataforma" style="width: 100%; padding: 10px; border-radius: 6px; background: rgba(255,255,255,0.05); color: white; border: 1px solid #334155;">
                                <option value="nenhuma">Nenhuma</option><option value="woocommerce">WooCommerce (WordPress)</option><option value="shopify">Shopify</option><option value="nuvemshop">Nuvemshop</option>
                            </select>
                        </div>
                        <div class="input-group" style="margin-top: 15px;"><label>URL da Loja</label><input type="text" id="ecom-url" placeholder="https://sualoja.com.br"></div>
                        <div class="input-group" style="margin-top: 15px;"><label>Chave da API (Key) ou ID Nuvemshop</label><input type="text" id="ecom-key"></div>
                        <div class="input-group" style="margin-top: 15px;"><label>Segredo da API (Secret) ou Token Nuvemshop</label><input type="password" id="ecom-secret"></div>
                        <button onclick="salvarConfiguracoesGerais()" class="btn-salvar" style="width: 100%; margin-top: 25px;">üíæ Salvar Integra√ß√£o</button>
                    </div>

                </div> 
            </div> 
        </div>
    </main>

    <script type="module">
        import { db, auth } from '../js/firebase-config.js';
        import { doc, getDoc, setDoc, collection, addDoc, getDocs, deleteDoc, query } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { validarSenhaMaster } from '../js/saas-utils.js';

        let logoBase64 = "";
        const empresaId = localStorage.getItem('VESTIO_EMPRESA_ID');

        window.abrirAba = function(abaId, btnSelecionado) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('ativo'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('ativo'));
            document.getElementById(abaId).classList.add('ativo');
            btnSelecionado.classList.add('ativo');
        }

        // FUN√á√ÉO DE BUSCA DO CEP
        window.buscarCep = async function(tipo) {
            const inputCep = document.getElementById(tipo + '-cep');
            let cep = inputCep.value.replace(/\D/g, ''); 
            if (cep.length !== 8) return;
            
            inputCep.value = cep.substring(0,5) + '-' + cep.substring(5);

            try {
                const res = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
                const data = await res.json();
                if (!data.erro) {
                    document.getElementById(tipo + '-rua').value = data.logradouro || '';
                    document.getElementById(tipo + '-bairro').value = data.bairro || '';
                    document.getElementById(tipo + '-cidade').value = data.localidade || '';
                    document.getElementById(tipo + '-uf').value = data.uf || '';
                    document.getElementById(tipo + '-num').focus(); 
                } else {
                    Swal.fire({title: 'Ops', text: 'CEP n√£o encontrado.', icon: 'warning', background: '#1e293b', color: '#fff'});
                }
            } catch (e) { console.error('Erro ViaCEP', e); }
        }

        window.copiarIdentificador = function() {
            navigator.clipboard.writeText(empresaId);
            Swal.fire({ title: 'Copiado!', text: 'ID da Empresa copiado com sucesso.', icon: 'success', timer: 2000, showConfirmButton: false });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if(!empresaId) return window.location.href="../index.html";
            document.getElementById('nome-utilizador').innerText = localStorage.getItem('VESTIO_USER_NAME') || 'Admin';

            const docRef = doc(db, "empresas", empresaId, "configuracoes", "dados_loja");
            const snap = await getDoc(docRef);
            if(snap.exists()){
                const d = snap.data();
                document.getElementById('loja-nome').value = d.nome || '';
                document.getElementById('loja-cnpj').value = d.cnpj || '';
                document.getElementById('loja-tel').value = d.telefone || '';
                document.getElementById('loja-insta').value = d.instagram || '';
                
                document.getElementById('loja-cep').value = d.cep || '';
                document.getElementById('loja-rua').value = d.rua || '';
                document.getElementById('loja-num').value = d.numero || '';
                document.getElementById('loja-bairro').value = d.bairro || '';
                document.getElementById('loja-cidade').value = d.cidade || '';
                document.getElementById('loja-uf').value = d.uf || '';
                
                if (!d.rua && d.endereco) { document.getElementById('loja-rua').value = d.endereco; }

                document.getElementById('juros-crediario').value = d.jurosCrediario || 0;
                document.getElementById('ecom-plataforma').value = d.ecom_plataforma || 'nenhuma';
                document.getElementById('ecom-url').value = d.ecom_url || '';
                document.getElementById('ecom-key').value = d.ecom_key || '';
                document.getElementById('ecom-secret').value = d.ecom_secret || '';

                if(d.logo) {
                    logoBase64 = d.logo;
                    document.getElementById('preview-logo').src = d.logo;
                    document.getElementById('preview-logo').style.display = 'block';
                    document.getElementById('placeholder-logo').style.display = 'none';
                }
            }

            carregarUsuarios();

            // GERADOR DO MANUAL DETALHADO COMPLETO (RECUPERADO)
            const btnInstrucoes = document.getElementById('btn-instrucoes-ecom');
            if(btnInstrucoes) {
                btnInstrucoes.addEventListener('click', (e) => {
                    e.preventDefault();
                    const conteudo = `==================================================
GUIA DE INTEGRA√á√ÉO VESTIO ERP -> LOJA ONLINE
==================================================
SEU IDENTIFICADOR √öNICO (WEBHOOK ID): ${empresaId}
(Guarde este c√≥digo. Ele ser√° o final do link que enviar√° as vendas para o seu sistema).

‚ñ∫ OP√á√ÉO 1: NUVEMSHOP (PASSO A PASSO DETALHADO)
--------------------------------------------------
PASSO 1: Aceda ao site especial para programadores da Nuvemshop: partners.nuvemshop.com.br
PASSO 2: Crie uma conta gratuita (ou fa√ßa login se j√° tiver).
PASSO 3: No painel esquerdo, clique em "Aplicativos" e depois no bot√£o "Criar novo aplicativo".
PASSO 4: Preencha o "Nome do Aplicativo" como "Vestio ERP". No campo "URL de redirecionamento", pode colocar o site da sua loja mesmo.
PASSO 5: V√° √† sec√ß√£o "Permiss√µes". Marque as caixas: "Ler e escrever produtos" e "Ler e escrever pedidos". Clique em Salvar.
PASSO 6: O sistema vai mostrar o seu aplicativo na lista. Clique no bot√£o azul "Instalar na minha loja". Ele vai redirecion√°-lo para a sua loja Nuvemshop para autorizar.
PASSO 7: Ap√≥s clicar em "Aceitar", a Nuvemshop vai gerar o seu **Token de Acesso** (uma chave longa). Copie esse Token!
PASSO 8: Volte ao Sistema Vestio, na aba Integra√ß√£o E-commerce:
         - Em 'Plataforma', selecione "Nuvemshop".
         - Em 'Chave da API (Key)', digite o **ID da sua Loja** (√© o n√∫mero que aparece no menu principal da sua Nuvemshop ou no URL administrativo).
         - Em 'Segredo da API (Secret)', cole o **Token de Acesso** que copiou no Passo 7.
PASSO 9: Clique em "Salvar Integra√ß√£o". O seu estoque j√° est√° ligado!
PASSO 10: Para receber pedidos no Vestio, v√° ao painel da Nuvemshop > Configura√ß√µes > C√≥digos Externos e crie um Webhook para o evento "order/paid" apontando para o seu link do Firebase terminado em: ?empresa=${empresaId}

‚ñ∫ OP√á√ÉO 2: WOOCOMMERCE (WORDPRESS)
--------------------------------------------------
PASSO 1: No painel WordPress, v√° a WooCommerce > Configura√ß√µes > Avan√ßado > API REST.
PASSO 2: Clique em "Adicionar Chave" e escolha as permiss√µes "Ler/Escrever".
PASSO 3: Copie a Chave e o Segredo e cole no Vestio.
PASSO 4: V√° a WooCommerce > Configura√ß√µes > Avan√ßado > Webhooks.
PASSO 5: Crie um Webhook para "Pedido Criado" e coloque o link do Firebase terminado em: ?empresa=${empresaId}

‚ñ∫ OP√á√ÉO 3: SHOPIFY
--------------------------------------------------
PASSO 1: No Admin Shopify, v√° a Configura√ß√µes > Apps e canais de vendas > Desenvolver apps.
PASSO 2: Crie o app "Vestio", libere permiss√µes de produtos e pedidos, e instale.
PASSO 3: Copie o Token de Acesso da API do Admin e cole no campo Secret do Vestio.
PASSO 4: V√° a Configura√ß√µes > Notifica√ß√µes > Webhooks e crie um para "Order creation" com formato JSON e o link do Firebase terminado em: ?empresa=${empresaId}
==================================================`;
                    const blob = new Blob([conteudo], { type: 'text/plain;charset=utf-8' });
                    const link = document.createElement('a'); link.href = window.URL.createObjectURL(blob); link.download = 'Instrucoes_Vestio.txt';
                    document.body.appendChild(link); link.click(); document.body.removeChild(link);
                });
            }

            document.getElementById('input-logo').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if(file){
                    const reader = new FileReader();
                    reader.onloadend = function(){ logoBase64 = reader.result; document.getElementById('preview-logo').src = logoBase64; document.getElementById('preview-logo').style.display = 'block'; document.getElementById('placeholder-logo').style.display = 'none'; }
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('btn-logout').onclick = async () => { await signOut(auth); window.location.href="../index.html"; };
        });

        // SALVAR DADOS
        window.salvarConfiguracoesGerais = async function() {
            const pass = await Swal.fire({ title: 'Autoriza√ß√£o Necess√°ria', input: 'password', background: '#1e293b', color: '#fff' });
            
            if (pass.isConfirmed && await validarSenhaMaster(pass.value)) {
                const rua = document.getElementById('loja-rua').value;
                const num = document.getElementById('loja-num').value;
                const bairro = document.getElementById('loja-bairro').value;
                const cidade = document.getElementById('loja-cidade').value;
                const uf = document.getElementById('loja-uf').value;
                const cep = document.getElementById('loja-cep').value;

                let enderecoCompleto = "";
                if(rua) enderecoCompleto = `${rua}, ${num || 'S/N'} - ${bairro}, ${cidade} - ${uf}. CEP: ${cep}`;

                const docRef = doc(db, "empresas", empresaId, "configuracoes", "dados_loja");
                await setDoc(docRef, {
                    nome: document.getElementById('loja-nome').value,
                    cnpj: document.getElementById('loja-cnpj').value,
                    telefone: document.getElementById('loja-tel').value,
                    instagram: document.getElementById('loja-insta').value,
                    
                    endereco: enderecoCompleto,
                    cep: cep, rua: rua, numero: num, bairro: bairro, cidade: cidade, uf: uf,
                    
                    jurosCrediario: parseFloat(document.getElementById('juros-crediario').value),
                    ecom_plataforma: document.getElementById('ecom-plataforma').value,
                    ecom_url: document.getElementById('ecom-url').value,
                    ecom_key: document.getElementById('ecom-key').value,
                    ecom_secret: document.getElementById('ecom-secret').value,
                    logo: logoBase64
                }, { merge: true });
                
                localStorage.setItem('VESTIO_LOGO', logoBase64);
                Swal.fire('Sucesso', 'Configura√ß√µes salvas e aplicadas!', 'success');
            } else if (pass.isConfirmed) { Swal.fire('Erro', 'Senha incorreta.', 'error'); }
        }

        async function carregarUsuarios() {
            const tbody = document.getElementById('lista-usuarios');
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Carregando...</td></tr>';
            try {
                const snap = await getDocs(query(collection(db, "empresas", empresaId, "usuarios")));
                tbody.innerHTML = '';
                snap.forEach(d => {
                    const u = d.data();
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${u.nome}</td><td><span style="background:${u.cargo==='Gerente'?'#FF453A':'#0A84FF'}; padding:3px 8px; border-radius:4px; font-size:11px;">${u.cargo}</span></td><td style="color:#94a3b8">***${u.senha.substring(u.senha.length-2)}</td><td><button onclick="window.excluirUsuario('${d.id}')" style="background:none; border:none; cursor:pointer; font-size:16px;">üóëÔ∏è</button></td>`;
                    tbody.appendChild(tr);
                });
            } catch (e) { console.error(e); }
        }

        document.getElementById('form-usuario').onsubmit = async (e) => {
            e.preventDefault();
            const pass = await Swal.fire({ title: 'Confirme sua Senha', input: 'password', background: '#1e293b', color: '#fff' });
            if (pass.isConfirmed && await validarSenhaMaster(pass.value)) {
                await addDoc(collection(db, "empresas", empresaId, "usuarios"), { nome: document.getElementById('usr-nome').value, cargo: document.getElementById('usr-cargo').value, senha: document.getElementById('usr-senha').value });
                document.getElementById('form-usuario').reset(); carregarUsuarios(); Swal.fire('Sucesso', 'Usu√°rio adicionado.', 'success');
            } else if (pass.isConfirmed) { Swal.fire('Erro', 'Senha inv√°lida.', 'error'); }
        };

        window.excluirUsuario = async function(id) {
            const pass = await Swal.fire({ title: 'Autoriza√ß√£o', input: 'password', background: '#1e293b', color: '#fff' });
            if (pass.isConfirmed && await validarSenhaMaster(pass.value)) { await deleteDoc(doc(db, "empresas", empresaId, "usuarios", id)); carregarUsuarios(); } else if (pass.isConfirmed) { Swal.fire('Erro', 'N√£o autorizado.', 'error'); }
        }
    </script>
</body>
</html>